
Ini perubahan dari Ary S

Donec quam felis, ultricies nec, pellentesque eu, pretium quis, sem. Nulla consequat massa quis enim. Donec pede justo, fringilla vel, aliquet nec, vulputate eget, arcu. In enim justo, rhoncus ut, imperdiet a, venenatis vitae, justo.

Nullam ( ini insert test) dictum felis eu pede mollis pretium. Integer tincidunt. Cras dapibus. Vivamus elementum semper nisi. Aenean vulputate eleifend tellus. Aenean leo ligula, porttitor eu, consequat vitae, eleifend ac, enim. Aliquam lorem ante, dapibus in, viverra quis, feugiat a, tellus.

Phasellus viverra nulla ut metus varius laoreet. Quisque rutrum. Aenean imperdiet. Etiam ultricies nisi vel augue. Curabitur ullamcorper ultricies nisi. Nam eget dui. Etiam rhoncus.

Maecenas tempus, tellus eget condimentum rhoncus, sem  semper libero, sit amet adipiscing sem neque sed ipsum. Nam quam nunc, blandit vel, luctus pulvinar, hendrerit id, lorem. Maecenas nec odio et ante tincidunt tempus. Donec vitae sapien ut libero venenatis faucibus. Nullam quis ante. Etiam sit amet orci eget eros faucibus tincidunt. Duis leo. Sed fringilla mauris sit amet nibh. Donec sodales sagittis magna. Sed consequat, leo eget bibendum sodales, augue velit cursus nunc,

--------------
ini penambahan
--------------

#using conversion tools version: 1.0.0.117
#-----------------------------------------
# Rd, 18/7/25
# fix arrFlag -> arrflag
#-----------------------------------------
from functions.additional_functions import *
from decimal import Decimal
from datetime import date
from functions.repeat_glist_1bl import repeat_glist_1bl

input_list_data, Input_list = create_model("Input_list", {"pvilanguage":int, "from_date":date, "to_date":date, "ci_date":date, "create_inhouse":bool, "sorttype":int, "modetype":int, "min_stay":int})


def repeat_glist_webbl(input_list_data:[Input_list]):
    g_list_data = []
    repeat_list_data = []
    cur_date_data = []
    pvilanguage:int = 0
    from_date:date = None
    to_date:date = None
    ci_date:date = None
    create_inhouse:bool = False
    sorttype:int = 0
    modetype:int = 0
    min_stay:int = 0

    input_list = g_list = repeat_list = cur_date = output_rlist = output_glist = None

    g_list_data, G_list = create_model("G_list", {"resnr":int, "gastnr":int, "name":string, "ankunft":date, "abreise":date, "zinr":string, "reslinnr":int, "zipreis":Decimal, "currency":string, "argt":string, "erwachs":int, "kind1":int, "gratis":int, "arrflag":bool, "resname":string, "lodging":Decimal})
    repeat_list_data, Repeat_list = create_model("Repeat_list", {"flag":int, "gastnr":int, "name":string, "nation":string, "birthdate":date, "email":string, "telefon":string, "vip":string, "city":string, "stay":int, "rmnite":int, "ankunft":date, "arrflag":bool, "zinr":string, "remark":string, "resname":string, "lodging":Decimal, "pax":int, "mobil_telefon":string})
    cur_date_data, Cur_date = create_model("Cur_date", {"curr_date":date})
    output_rlist_data, Output_rlist = create_model_like(Repeat_list)
    output_glist_data, Output_glist = create_model_like(G_list)

    db_session = local_storage.db_session

    def generate_output():
        nonlocal g_list_data, repeat_list_data, cur_date_data, pvilanguage, from_date, to_date, ci_date, create_inhouse, sorttype, modetype, min_stay


        nonlocal input_list, g_list, repeat_list, cur_date, output_rlist, output_glist
        nonlocal g_list_data, repeat_list_data, cur_date_data, output_rlist_data, output_glist_data

        return {"g-list": g_list_data, "repeat-list": repeat_list_data, "cur-date": cur_date_data}

    def disp_repeatlist():

        nonlocal g_list_data, repeat_list_data, cur_date_data, pvilanguage, from_date, to_date, ci_date, create_inhouse, sorttype, modetype, min_stay


        nonlocal input_list, g_list, repeat_list, cur_date, output_rlist, output_glist
        nonlocal g_list_data, repeat_list_data, cur_date_data, output_rlist_data, output_glist_data

        tot_lodging:Decimal = to_decimal("0.0")
        tot_stay:int = 0
        tot_rmnight:int = 0
        tot_pax:int = 0

        if sorttype == 0:

            for output_rlist in query(output_rlist_data, sort_by=[("stay",True),("name",False)]):

                if (output_rlist.stay >= min_stay) or (output_rlist.stay >= (min_stay - 1) and output_rlist.arrflag):
                    repeat_list = Repeat_list()
                    repeat_list_data.append(repeat_list)

                    repeat_list.flag = output_rlist.flag
                    repeat_list.gastnr = output_rlist.gastnr
                    repeat_list.name = output_rlist.name
                    repeat_list.nation = output_rlist.nation
                    repeat_list.birthdate = output_rlist.birthdate
                    repeat_list.email = output_rlist.email
                    repeat_list.telefon = output_rlist.telefon
                    repeat_list.vip = output_rlist.vip
                    repeat_list.city = output_rlist.city
                    repeat_list.stay = output_rlist.stay
                    repeat_list.rmnite = output_rlist.rmnite
                    repeat_list.ankunft = output_rlist.ankunft
                    repeat_list.arrflag = output_rlist.arrflag
                    repeat_list.zinr = output_rlist.zinr
                    repeat_list.remark = output_rlist.remark
                    repeat_list.resname = output_rlist.resname
                    repeat_list.lodging =  to_decimal(output_rlist.lodging)
                    repeat_list.pax = output_rlist.pax
                    repeat_list.mobil_telefon = output_rlist.mobil_telefon
                    tot_lodging =  to_decimal(tot_lodging) + to_decimal(output_rlist.lodging)
                    tot_stay = tot_stay + output_rlist.stay
                    tot_rmnight = tot_rmnight + output_rlist.rmnite
                    tot_pax = tot_pax + output_rlist.pax


            repeat_list = Repeat_list()
            repeat_list_data.append(repeat_list)

            repeat_list.city = "T O T A L"
            repeat_list.stay = tot_stay
            repeat_list.lodging =  to_decimal(tot_lodging)
            repeat_list.rmnite = tot_rmnight
            repeat_list.zinr = " "
            repeat_list.pax = tot_pax


        else:

            if sorttype == 1:

                for output_rlist in query(output_rlist_data, sort_by=[("stay",True),("name",False)]):

                    if output_rlist.flag == sorttype and ((output_rlist.stay >= min_stay) or (output_rlist.stay >= (min_stay - 1) and output_rlist.arrflag)) and output_rlist.ankunft >= from_date and output_rlist.ankunft <= to_date:
                        repeat_list = Repeat_list()
                        repeat_list_data.append(repeat_list)

                        repeat_list.flag = output_rlist.flag
                        repeat_list.gastnr = output_rlist.gastnr
                        repeat_list.name = output_rlist.name
                        repeat_list.nation = output_rlist.nation
                        repeat_list.birthdate = output_rlist.birthdate
                        repeat_list.email = output_rlist.email
                        repeat_list.telefon = output_rlist.telefon
                        repeat_list.vip = output_rlist.vip
                        repeat_list.city = output_rlist.city
                        repeat_list.stay = output_rlist.stay
                        repeat_list.rmnite = output_rlist.rmnite
                        repeat_list.ankunft = output_rlist.ankunft
                        repeat_list.arrflag = output_rlist.arrflag
                        repeat_list.zinr = output_rlist.zinr
                        repeat_list.remark = output_rlist.remark
                        repeat_list.resname = output_rlist.resname
                        repeat_list.lodging =  to_decimal(output_rlist.lodging)
                        repeat_list.pax = output_rlist.pax
                        repeat_list.mobil_telefon = output_rlist.mobil_telefon
                        tot_lodging =  to_decimal(tot_lodging) + to_decimal(output_rlist.lodging)
                        tot_pax = tot_pax + output_rlist.pax


                output_rlist = Output_rlist()
                output_rlist_data.append(output_rlist)

                output_rlist.city = "T O T A L"
                output_rlist.stay = 999
                output_rlist.lodging =  to_decimal(tot_lodging)
                output_rlist.zinr = " "
                output_rlist.pax = tot_pax


            else:

                for output_rlist in query(output_rlist_data, sort_by=[("stay",True),("name",False)]):

                    if output_rlist.flag == sorttype and ((output_rlist.stay >= min_stay) or (output_rlist.stay >= (min_stay - 1) and output_rlist.arrflag)):
                        repeat_list = Repeat_list()
                        repeat_list_data.append(repeat_list)

                        repeat_list.flag = output_rlist.flag
                        repeat_list.gastnr = output_rlist.gastnr
                        repeat_list.name = output_rlist.name
                        repeat_list.nation = output_rlist.nation
                        repeat_list.birthdate = output_rlist.birthdate
                        repeat_list.email = output_rlist.email
                        repeat_list.telefon = output_rlist.telefon
                        repeat_list.vip = output_rlist.vip
                        repeat_list.city = output_rlist.city
                        repeat_list.stay = output_rlist.stay
                        repeat_list.rmnite = output_rlist.rmnite
                        repeat_list.ankunft = output_rlist.ankunft
                        repeat_list.arrflag = output_rlist.arrflag
                        repeat_list.zinr = output_rlist.zinr
                        repeat_list.remark = output_rlist.remark
                        repeat_list.resname = output_rlist.resname
                        repeat_list.lodging =  to_decimal(output_rlist.lodging)
                        repeat_list.pax = output_rlist.pax
                        repeat_list.mobil_telefon = output_rlist.mobil_telefon
                        tot_lodging =  to_decimal(tot_lodging) + to_decimal(output_rlist.lodging)
                        tot_pax = tot_pax + output_rlist.pax


                output_rlist = Output_rlist()
                output_rlist_data.append(output_rlist)

                output_rlist.city = "T O T A L"
                output_rlist.stay = 999
                output_rlist.lodging =  to_decimal(tot_lodging)
                output_rlist.zinr = " "
                output_rlist.pax = tot_pax


    def disp_guesthistory():

        nonlocal g_list_data, repeat_list_data, cur_date_data, pvilanguage, from_date, to_date, ci_date, create_inhouse, sorttype, modetype, min_stay


        nonlocal input_list, g_list, repeat_list, cur_date, output_rlist, output_glist
        nonlocal g_list_data, repeat_list_data, cur_date_data, output_rlist_data, output_glist_data

        for output_glist in query(output_glist_data, filters=(lambda output_glist: output_glist.gastnr == sorttype), sort_by=[("ankunft",False)]):
            g_list = G_list()
            g_list_data.append(g_list)

            g_list.resnr = output_glist.resnr
            g_list.gastnr = output_glist.gastnr
            g_list.name = output_glist.name
            g_list.ankunft = output_glist.ankunft
            g_list.abreise = output_glist.abreise
            g_list.zinr = output_glist.zinr
            g_list.reslinnr = output_glist.reslinnr
            g_list.zipreis =  to_decimal(output_glist.zipreis)
            g_list.currency = output_glist.currency
            g_list.argt = output_glist.argt
            g_list.erwachs = output_glist.erwachs
            g_list.kind1 = output_glist.kind1
            g_list.gratis = output_glist.gratis
            g_list.arrflag = output_glist.arrflag
            g_list.resname = output_glist.resname
            g_list.lodging =  to_decimal(output_glist.lodging)

    input_list = query(input_list_data, first=True)

    if not input_list:

        return generate_output()
    else:
        pvilanguage = input_list.pvilanguage
        from_date = input_list.from_date
        to_date = input_list.to_date
        ci_date = input_list.ci_date
        create_inhouse = input_list.create_inhouse
        sorttype = input_list.sorttype
        modetype = input_list.modetype
        min_stay = input_list.min_stay


    output_glist_data, output_rlist_data, cur_date_data = get_output(repeat_glist_1bl(pvilanguage, from_date, to_date, ci_date, create_inhouse))

    if modetype == 1:
        disp_repeatlist()

    elif modetype == 2:
        disp_guesthistory()

    return generate_output()
