#using conversion tools version: 1.0.0.117
#-----------------------------------------
# Rd 28/7/2025
# gitlab: 763
# payload:
# {
#     "request": {
#         "autosaldo": false,
#         "pricetab": false,
#         "doubleCurrency": false,
#         "artnr": 110,
#         "balance": 309000,
#         "balanceForeign": 0,
#         "billart": 110,
#         "vatArtlist": [
#             1001,
#             0,
#             0,
#             0
#         ],
#         "lvAnzVat": 1,
#         "currDepartment ": 0,
#         "bilRecid": 197289,
#         "inputUserkey": "95EE44CBF839764A7690C157AC66C9C902905E01",
#         "inputUsername": "it",
#         "hotel_schema": "qcserverless3"
#     }
# }
# {
#     "request": {
#         "amount": 521.02,
#         "tAmount": 861383.924208,
#         "pvILanguage": "1",
#         "userInit": "41",
#         "sArtnr": 3750056,
#         "qty": 2,
#         "transfered": true,
#         "costAcct": " ",
#         "currLager": 1,
#         "price": 260.51,
#         "transdate": "09/24/24",
#         "lscheinnr": "R240924001",
#         "outList": {
#             "out-list": [
#                 {
#                     "artnr": 3750056
#                 }
#             ]
#         },
#         "opList": {
#             "op-list": [
#                 {
#                     "artnr": 1120486,
#                     "datum": "2024-09-24",
#                     "zeit": 22621,
#                     "lief-nr": 0,
#                     "lager-nr": 1,
#                     "anzahl": 24,
#                     "einzelpreis": 15341.246,
#                     "warenwert": 368189.907504,
#                     "op-art": 14,
#                     "herkunftflag": 1,
#                     "loeschflag": 0,
#                     "fuellflag": 161,
#                     "reorgflag": 5,
#                     "rueckgabegrund": 0,
#                     "flag": false,
#                     "stornogrund": "",
#                     "docu-nr": "",
#                     "lscheinnr": "R240924001",
#                     "pos": 9,
#                     "betriebsnr": 0,
#                     "deci1": [
#                         0,
#                         0,
#                         0,
#                         0
#                     ],
#                     "bezeich": "DAIRY - Grandairy Full Cream Milk 1 Ltr",
#                     "username": "rama",
#                     "onhand": 84,
#                     "new-flag": false
#                 },
#                 {
#                     "artnr": 1190005,
#                     "datum": "2024-09-24",
#                     "zeit": 22622,
#                     "lief-nr": 0,
#                     "lager-nr": 1,
#                     "anzahl": 2,
#                     "einzelpreis": 18463.918,
#                     "warenwert": 36927.835052,
#                     "op-art": 14,
#                     "herkunftflag": 1,
#                     "loeschflag": 0,
#                     "fuellflag": 161,
#                     "reorgflag": 5,
#                     "rueckgabegrund": 0,
#                     "flag": false,
#                     "stornogrund": "",
#                     "docu-nr": "",
#                     "lscheinnr": "R240924001",
#                     "pos": 9,
#                     "betriebsnr": 0,
#                     "deci1": [
#                         0,
#                         0,
#                         0,
#                         0
#                     ],
#                     "bezeich": "GROCE - Gula Putih_Gulaku @1 Kg",
#                     "username": "rama",
#                     "onhand": 17,
#                     "new-flag": false
#                 },
#                 {
#                     "artnr": 1290010,
#                     "datum": "2024-09-24",
#                     "zeit": 22623,
#                     "lief-nr": 0,
#                     "lager-nr": 1,
#                     "anzahl": 250,
#                     "einzelpreis": 239.989,
#                     "warenwert": 59997.2165,
#                     "op-art": 14,
#                     "herkunftflag": 1,
#                     "loeschflag": 0,
#                     "fuellflag": 161,
#                     "reorgflag": 5,
#                     "rueckgabegrund": 0,
#                     "flag": false,
#                     "stornogrund": "",
#                     "docu-nr": "",
#                     "lscheinnr": "R240924001",
#                     "pos": 9,
#                     "betriebsnr": 0,
#                     "deci1": [
#                         0,
#                         0,
#                         0,
#                         0
#                     ],
#                     "bezeich": "TEA - White Sugar Stick_Neo",
#                     "username": "rama",
#                     "onhand": 2500,
#                     "new-flag": false
#                 },
#                 {
#                     "artnr": 1290074,
#                     "datum": "2024-09-24",
#                     "zeit": 22624,
#                     "lief-nr": 0,
#                     "lager-nr": 1,
#                     "anzahl": 4,
#                     "einzelpreis": 12955.349,
#                     "warenwert": 51821.395348,
#                     "op-art": 14,
#                     "herkunftflag": 1,
#                     "loeschflag": 0,
#                     "fuellflag": 161,
#                     "reorgflag": 5,
#                     "rueckgabegrund": 0,
#                     "flag": false,
#                     "stornogrund": "",
#                     "docu-nr": "",
#                     "lscheinnr": "R240924001",
#                     "pos": 9,
#                     "betriebsnr": 0,
#                     "deci1": [
#                         0,
#                         0,
#                         0,
#                         0
#                     ],
#                     "bezeich": "MIWA - Cheers Reff 19ltr ( Food )",
#                     "username": "rama",
#                     "onhand": 13,
#                     "new-flag": false
#                 },
#                 {
#                     "artnr": 1290075,
#                     "datum": "2024-09-24",
#                     "zeit": 22625,
#                     "lief-nr": 0,
#                     "lager-nr": 1,
#                     "anzahl": 1000,
#                     "einzelpreis": 150.344,
#                     "warenwert": 150343.58,
#                     "op-art": 14,
#                     "herkunftflag": 1,
#                     "loeschflag": 0,
#                     "fuellflag": 161,
#                     "reorgflag": 5,
#                     "rueckgabegrund": 0,
#                     "flag": false,
#                     "stornogrund": "",
#                     "docu-nr": "",
#                     "lscheinnr": "R240924001",
#                     "pos": 9,
#                     "betriebsnr": 0,
#                     "deci1": [
#                         0,
#                         0,
#                         0,
#                         0
#                     ],
#                     "bezeich": "COFFEE - N Banyuatis Robusta Powder 500gr",
#                     "username": "rama",
#                     "onhand": 4500,
#                     "new-flag": false
#                 },
#                 {
#                     "artnr": 2520002,
#                     "datum": "2024-09-24",
#                     "zeit": 22626,
#                     "lief-nr": 0,
#                     "lager-nr": 1,
#                     "anzahl": 500,
#                     "einzelpreis": 258.974,
#                     "warenwert": 129486.756,
#                     "op-art": 14,
#                     "herkunftflag": 1,
#                     "loeschflag": 0,
#                     "fuellflag": 161,
#                     "reorgflag": 5,
#                     "rueckgabegrund": 0,
#                     "flag": false,
#                     "stornogrund": "",
#                     "docu-nr": "",
#                     "lscheinnr": "R240924001",
#                     "pos": 9,
#                     "betriebsnr": 0,
#                     "deci1": [
#                         0,
#                         0,
#                         0,
#                         0
#                     ],
#                     "bezeich": "COFFEE - Banyuatis Arabica Bean Roasted 500gr",
#                     "username": "rama",
#                     "onhand": 3000,
#                     "new-flag": false
#                 },
#                 {
#                     "artnr": 3650029,
#                     "datum": "2024-09-24",
#                     "zeit": 22627,
#                     "lief-nr": 0,
#                     "lager-nr": 1,
#                     "anzahl": 10,
#                     "einzelpreis": 850,
#                     "warenwert": 8500,
#                     "op-art": 14,
#                     "herkunftflag": 1,
#                     "loeschflag": 0,
#                     "fuellflag": 161,
#                     "reorgflag": 5,
#                     "rueckgabegrund": 0,
#                     "flag": false,
#                     "stornogrund": "",
#                     "docu-nr": "",
#                     "lscheinnr": "R240924001",
#                     "pos": 9,
#                     "betriebsnr": 0,
#                     "deci1": [
#                         0,
#                         0,
#                         0,
#                         0
#                     ],
#                     "bezeich": "CLEAN SUP - Garbage Bag 90x100",
#                     "username": "rama",
#                     "onhand": 270,
#                     "new-flag": false
#                 },
#                 {
#                     "artnr": 3750046,
#                     "datum": "2024-09-24",
#                     "zeit": 22628,
#                     "lief-nr": 0,
#                     "lager-nr": 1,
#                     "anzahl": 2,
#                     "einzelpreis": 7500.135,
#                     "warenwert": 15000.269904,
#                     "op-art": 14,
#                     "herkunftflag": 1,
#                     "loeschflag": 0,
#                     "fuellflag": 161,
#                     "reorgflag": 5,
#                     "rueckgabegrund": 0,
#                     "flag": false,
#                     "stornogrund": "",
#                     "docu-nr": "",
#                     "lscheinnr": "R240924001",
#                     "pos": 9,
#                     "betriebsnr": 0,
#                     "deci1": [
#                         0,
#                         0,
#                         0,
#                         0
#                     ],
#                     "bezeich": "GUEST SUP - Tissue Dinner Napkin - Logo Neo",
#                     "username": "rama",
#                     "onhand": 24,
#                     "new-flag": false
#                 },
#                 {
#                     "artnr": 3750062,
#                     "datum": "2024-09-24",
#                     "zeit": 22629,
#                     "lief-nr": 0,
#                     "lager-nr": 1,
#                     "anzahl": 5,
#                     "einzelpreis": 5423.393,
#                     "warenwert": 27116.963905,
#                     "op-art": 14,
#                     "herkunftflag": 1,
#                     "loeschflag": 0,
#                     "fuellflag": 161,
#                     "reorgflag": 5,
#                     "rueckgabegrund": 0,
#                     "flag": false,
#                     "stornogrund": "",
#                     "docu-nr": "",
#                     "lscheinnr": "R240924001",
#                     "pos": 9,
#                     "betriebsnr": 0,
#                     "deci1": [
#                         0,
#                         0,
#                         0,
#                         0
#                     ],
#                     "bezeich": "GUEST SUP - Tissu Cocktail logo Neo",
#                     "username": "rama",
#                     "onhand": 127,
#                     "new-flag": false
#                 },
#                 {
#                     "artnr": 3780011,
#                     "datum": "2024-09-24",
#                     "zeit": 22630,
#                     "lief-nr": 0,
#                     "lager-nr": 1,
#                     "anzahl": 1,
#                     "einzelpreis": 14000,
#                     "warenwert": 13999.999995,
#                     "op-art": 14,
#                     "herkunftflag": 1,
#                     "loeschflag": 0,
#                     "fuellflag": 161,
#                     "reorgflag": 5,
#                     "rueckgabegrund": 0,
#                     "flag": false,
#                     "stornogrund": "",
#                     "docu-nr": "",
#                     "lscheinnr": "R240924001",
#                     "pos": 9,
#                     "betriebsnr": 0,
#                     "deci1": [
#                         0,
#                         0,
#                         0,
#                         0
#                     ],
#                     "bezeich": "PRINT - Captain Order",
#                     "username": "rama",
#                     "onhand": 29,
#                     "new-flag": false
#                 }
#             ]
#         },
#         "inputUserkey": "95EE44CBF839764A7690C157AC66C9C902905E01",
#         "inputUsername": "it",
#         "hotel_schema": "qcserverless3"
#     }
# }
#-----------------------------------------

from functions.additional_functions import *
from decimal import Decimal
from functions.fo_invoice_return_qtybl import fo_invoice_return_qtybl
from functions.fo_invoice_calculate_unitpricebl import fo_invoice_calculate_unitpricebl

def fo_inv_calc_unitprice_listbl(autosaldo:bool, pricetab:bool, double_currency:bool, artnr:int, balance:Decimal, balance_foreign:Decimal, billart:int, vat_artlist:[int], lvanzvat:int, curr_department:int, bil_recid:int):
    price = to_decimal("0.0")
    exrate = to_decimal("0.0")
    found = False
    msg = 0
    amt:Decimal = to_decimal("0.0")
    ind:int = 0

    db_session = local_storage.db_session

    def generate_output():
        nonlocal price, exrate, found, msg, amt, ind
        nonlocal autosaldo, pricetab, double_currency, artnr, balance, balance_foreign, billart, vat_artlist, lvanzvat, curr_department, bil_recid

        return {"price": price, "exrate": exrate, "found": found, "msg": msg}


    if autosaldo:

        if pricetab or double_currency:

            if double_currency:

                if pricetab:
                    price =  - to_decimal(balance_foreign)
                else:
                    price =  - to_decimal(balance)
            else:
                exrate, price, msg = get_output(fo_invoice_return_qtybl(artnr, balance))
        else:
            for ind in range(1,lvanzvat + 1) :

                if billart == vat_artlist[ind - 1]:
                    found = True

            if not found or curr_department > 0:
                price =  - to_decimal(balance)

                return generate_output()
            amt = get_output(fo_invoice_calculate_unitpricebl(billart, bil_recid))
            price =  to_decimal(amt)

    return generate_output()